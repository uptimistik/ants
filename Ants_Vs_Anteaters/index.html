<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Game with Firebase Leaderboard</title>
  <link rel="stylesheet" type="text/css" href="css/gse-style.css" />
  <link rel="stylesheet" type="text/css" href="css/gse-style-loading.css" />
  <style type="text/css">
    body {
      background-color: black;
      margin: 0;
      padding: 0;
    }
    #log {
      color: white;
      background: rgba(0, 0, 0, 0.8);
      position: absolute;
      top: 10px;
      left: 10px;
      padding: 10px;
      max-height: 200px;
      overflow-y: scroll;
      z-index: 1000;
    }
    #end-game-overlay {
      display: none;
      color: white;
      background: rgba(0, 0, 0, 0.8);
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      text-align: center;
      padding: 20px;
      box-sizing: border-box;
      z-index: 1000;
    }
  </style>
  <script src="https://www.gstatic.com/firebasejs/9.9.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.9.2/firebase-database-compat.js"></script>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
  <div id="gse-player" class="gse-frame">
    <div class="gse-overlay">
      <div id="gse-text" class="gse-dialog">
        <div>
          <button id="gse-text-cancel">Cancel</button>
          <button id="gse-text-done">Done</button>
          <p id="gse-text-prompt">Enter Username:</p>
        </div>
        <div>
          <textarea id="gse-text-input" placeholder="Enter your username"></textarea>
        </div>
      </div>
      <div id="gse-loading" style="visibility: visible;">
        <img src="images/gse-loading.png" />
      </div>
    </div>
  </div>

  <div id="end-game-overlay">
    <h2>Ants Leaderboards</h2>
    <div id="top-players"></div>
    <div id="current-position"></div>
  </div>

  <script type="text/javascript">
    document.addEventListener('DOMContentLoaded', function() {
      const firebaseConfig = {
        apiKey: "AIzaSyCeS_7ev8inI1yvzkljhJn_IU7z5cJIp9k",
        authDomain: "antsgame-204c1.firebaseapp.com",
        databaseURL: "https://antsgame-204c1-default-rtdb.firebaseio.com",
        projectId: "antsgame-204c1",
        storageBucket: "antsgame-204c1.appspot.com",
        messagingSenderId: "580715522171",
        appId: "1:580715522171:web:0bba6c6a16399dc3fe5ade",
        measurementId: "G-E0JEEGY1GR"
      };

      firebase.initializeApp(firebaseConfig);
      const database = firebase.database();

      let playerId = null;
      let playerName = 'Unknown';

      function generateUniqueId() {
        return 'xxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
          var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
          return v.toString(16);
        });
      }

      function showUsernameOverlay() {
        document.getElementById('gse-text').style.display = 'block';
      }

      function hideUsernameOverlay() {
        document.getElementById('gse-text').style.display = 'none';
      }

      function checkUser() {
        const userId = window.localStorage.getItem('playerId');
        if (userId) {
          playerId = userId;
          database.ref(`players/${playerId}`).once('value').then(snapshot => {
            if (snapshot.exists()) {
              playerName = snapshot.val().username;
              hideUsernameOverlay();
              startGame();
            } else {
              showUsernameOverlay();
            }
          });
        } else {
          showUsernameOverlay();
        }
      }

      function saveUsername(username) {
        if (!username) return;
        playerId = generateUniqueId();
        window.localStorage.setItem('playerId', playerId);
        database.ref(`players/${playerId}`).set({ username: username })
          .then(() => {
            playerName = username;
            hideUsernameOverlay();
            startGame();
          })
          .catch(error => console.error('Error saving username:', error));
      }

      function startGame() {
        console.log('Starting game for', playerName);
      }

      function saveScoreToFirebase(score) {
        if (!playerName || playerName === 'Unknown') {
          console.error('Failed to retrieve username');
          return;
        }

        const scoresRef = database.ref('scores');
        const newScoreRef = scoresRef.push();
        newScoreRef.set({
          id: playerId,
          name: playerName,
          score: score
        });
      }

      function loadLeaderboard() {
        const scoresRef = database.ref('scores').orderByChild('score').limitToLast(10);
        scoresRef.once('value', (snapshot) => {
          const scores = [];
          snapshot.forEach((childSnapshot) => {
            scores.unshift(childSnapshot.val()); // Add to the beginning to sort in descending order
          });
          displayLeaderboard(scores);
        });
      }

      function displayLeaderboard(scores) {
        const leaderboardElement = document.getElementById('top-players');
        if (leaderboardElement) {
          leaderboardElement.innerHTML = '';
          scores.forEach((entry) => {
            const entryElement = document.createElement('div');
            entryElement.textContent = `${entry.name}: Total Kills: ${entry.score}`;
            leaderboardElement.appendChild(entryElement);
          });

          // Check current player position
          const currentPositionElement = document.getElementById('current-position');
          const currentPlayerScore = scores.find(score => score.id === playerId);
          if (currentPlayerScore) {
            currentPositionElement.textContent = `Your Position: ${scores.indexOf(currentPlayerScore) + 1}`;
          } else {
            currentPositionElement.textContent = 'You are not in the top 10';
          }

          document.getElementById('end-game-overlay').style.display = 'block';
        } else {
          console.error('Leaderboard element not found.');
        }
      }

      window.onEngineLoad = function() {
        gse.ready(function(engine) {
          const loadingElement = document.getElementById('gse-loading');

          var playerDelegate = {
            onGameCenterPostScore: function(score, leaderboard) {
              saveScoreToFirebase(score);
            },
            onGameCenterShowLeaderboard: function(identifier) {
              loadLeaderboard(); // Load and display the leaderboard when the delegate is triggered
            },
            onLoadingBegin: function() {
              engine.showOverlay();
              loadingElement.style.visibility = 'visible';
            },
            onLoadingEnd: function() {
              loadingElement.style.visibility = 'hidden';
              engine.hideOverlay();
            },
            onGameReady: function() {
              // Load and display the leaderboard when the game is ready
              loadLeaderboard();
            },
            onWindowResize: function() {
              engine.relayout();
            }
          };

          engine.appendDelegate(playerDelegate);
          window.addEventListener('resize', playerDelegate.onWindowResize, false);

          engine.setRenderFrame('gse-player');
          engine.setOptions({
            'viewport-reference': 'window',
            'viewport-fit': 'letterbox'
          });
          engine.loadOptionsFromURL();
          engine.play();

          checkUser(); // Check if user already exists
        });
      };
    });
  </script>
  <script type="text/javascript" src="js/gse/gse-export.js" async onload="onEngineLoad()"></script>
</body>
</html>
