<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Colony Clash</title>
    <link rel="stylesheet" href="css/gse-style.css">
    <link rel="stylesheet" href="css/gse-style-loading.css">
    <link rel="stylesheet" href="css/styles.css">
    <style>
    body {
        background-color: black;
        margin: 0;
        padding: 0;
    }

    .overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
        z-index: 10000;
    }

    .overlay-content {
        background-color: black;
        color: white;
        padding: 20px;
        border-radius: 10px;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
        max-width: 80%;
        max-height: 80%;
        overflow: auto;
    }

    #leaderboard-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        margin-top: 20px;
        margin-bottom: 20px;
        color: white;
    }

    #leaderboard-table thead {
        position: sticky;
        top: 0;
        background-color: #4CAF50;
    }

    #leaderboard-table tbody {
        display: block;
        max-height: 50vh;
        overflow-y: auto;
    }

    #leaderboard-table thead,
    #leaderboard-table tbody tr {
        display: table;
        width: 100%;
        table-layout: fixed;
    }

    #leaderboard-table th,
    #leaderboard-table td {
        padding: 10px;
        border: 1px solid #4CAF50;
        text-align: center;
    }

    #leaderboard-table th {
        background-color: #4CAF50;
        color: white;
    }

    #leaderboard-table th:first-child,
    #leaderboard-table td:first-child {
        width: 15%;
    }

    #leaderboard-table th:nth-child(2),
    #leaderboard-table td:nth-child(2) {
        width: 55%;
    }

    #leaderboard-table th:last-child,
    #leaderboard-table td:last-child {
        width: 30%;
    }

    .yellow-text {
        color: yellow;
        font-size: 1.2rem;
    }

    #leaderboard-close-btn {
        background-color: #4CAF50;
        color: white;
        border: none;
        padding: 10px 20px;
        margin-top: 15px;
        cursor: pointer;
        font-size: 1rem;
    }

    .ant-icon {
        display: inline-block;
        width: 30px;
        height: 30px;
        border-radius: 50%;
        background-color: #4CAF50;
        color: white;
        text-align: center;
        line-height: 30px;
        margin-right: 10px;
        font-size: 1rem;
    }

    .yellow-dot {
        display: inline-block;
        width: 10px;
        height: 10px;
        background-color: yellow;
        border-radius: 50%;
        margin-left: 5px;
    }
    </style>
</head>
<body>
    <div id="gse-player" class="gse-frame">
        <div class="gse-overlay">
            <div id="gse-loading" style="visibility: visible;">
                <img src="images/gse-loading.png" alt="Loading...">
            </div>
        </div>
    </div>

    <div id="username-overlay" class="overlay">
        <div class="overlay-content">
            <h2>Create A Username</h2>
            <input type="text" id="username-input" placeholder="Enter A Username">
            <button id="username-submit-btn">Submit</button>
        </div>
    </div>

    <div id="leaderboard-overlay" class="overlay">
        <div class="overlay-content">
            <h2>Colony Clash Leaderboard</h2>
            <p id="total-ants">Total Ants: <span>0</span></p>
            <p id="leaderboard-status" class="yellow-text">Leaderboard reset on Sunday 12pm EST!</p>
            <table id="leaderboard-table">
                <thead>
                    <tr>
                        <th>Rank</th>
                        <th>Username</th>
                        <th>Top Kills</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Leaderboard entries will be dynamically inserted here -->
                </tbody>
            </table>
            <button id="leaderboard-close-btn">Back</button>
        </div>
    </div>

    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="js/app.js"></script>
    <script>
    (function() {
        let gameEngine;
        const LAST_SCORE_ATTRIBUTE = 'id116155';

        function checkExistingAccount() {
            if (localStorage.getItem('antUsername')) {
                loadGame();
            } else {
                showUsernameOverlay();
            }
        }

        function showUsernameOverlay() {
            document.getElementById('username-overlay').style.display = 'flex';
            document.getElementById('username-input').focus();
        }

        function createUsername(username) {
            const userRef = firebase.database().ref('users').push();
            userRef.set({
                username: username,
                createdAt: firebase.database.ServerValue.TIMESTAMP,
                lastScore: 0
            }).then(function() {
                localStorage.setItem('antUsername', username);
                localStorage.setItem('antUserId', userRef.key);
                document.getElementById('username-overlay').style.display = 'none';
                loadGame();
            }).catch(function(error) {
                console.error("Error creating user:", error);
                alert("Error creating user. Please try again.");
            });
        }

        function loadGame() {
            Telegram.WebApp.ready();
            Telegram.WebApp.onEvent('mainButtonClicked', function() {
                // Action when Telegram main button is clicked
            });

            window.onEngineLoad = function() {
                gse.ready(function(engine) {
                    gameEngine = engine;
                    var loadingElement = document.getElementById('gse-loading');
                    var playerDelegate = {
                        onLoadingBegin: function() {
                            engine.showOverlay();
                            loadingElement.style.visibility = 'visible';
                        },
                        onLoadingEnd: function() {
                            loadingElement.style.visibility = 'hidden';
                            engine.hideOverlay();
                        },
                        onWindowResize: function() {
                            engine.relayout();
                        },
                        onGameCenterShowLeaderboard: function(identifier) {
                            displayLeaderboard(identifier);
                        },
                        onGameCenterPostScore: function(score, identifier) {
                            updateUserScore(score, identifier);
                        }
                    };

                    engine.appendDelegate(playerDelegate);
                    window.addEventListener('resize', playerDelegate.onWindowResize, false);

                    engine.setRenderFrame('gse-player');
                    engine.setOptions({
                        'viewport-reference': 'window',
                        'viewport-fit': 'overscan'
                    });
                    engine.loadOptionsFromURL();
                    engine.play();
                });
            };

            var script = document.createElement('script');
            script.type = 'text/javascript';
            script.src = 'js/gse/gse-export.js';
            script.async = true;
            script.onload = window.onEngineLoad;
            document.body.appendChild(script);
        }

        function displayLeaderboard(identifier) {
            Promise.all([
                firebase.database().ref('leaderboards/' + identifier).once('value'),
                firebase.database().ref('users').once('value')
            ]).then(function([leaderboardSnapshot, usersSnapshot]) {
                let leaderboardData = [];
                
                // Combine data from leaderboards and users
                leaderboardSnapshot.forEach(function(childSnapshot) {
                    leaderboardData.push({
                        username: childSnapshot.val().username,
                        score: childSnapshot.val().score
                    });
                });
                
                usersSnapshot.forEach(function(childSnapshot) {
                    if (childSnapshot.val().lastScore) {
                        leaderboardData.push({
                            username: childSnapshot.val().username,
                            score: childSnapshot.val().lastScore
                        });
                    }
                });

                // Remove duplicates (if any) and sort
                leaderboardData = Array.from(new Set(leaderboardData.map(JSON.stringify))).map(JSON.parse);
                leaderboardData.sort((a, b) => b.score - a.score);

                const username = localStorage.getItem('antUsername');
                const userScore = leaderboardData.find(entry => entry.username === username)?.score || 'N/A';

                populateLeaderboard(leaderboardData, username, userScore);
                document.getElementById('leaderboard-overlay').style.display = 'flex';

                // Update total players count
                const totalUsers = usersSnapshot.numChildren();
                document.getElementById('total-ants').querySelector('span').textContent = totalUsers;

                // Read and display the last score attribute
                gameEngine.postEvent('externalReadGameAttribute', function(lastScore) {
                    document.getElementById('last-score-value').textContent = lastScore || 'N/A';
                }, `game.attributes.${LAST_SCORE_ATTRIBUTE}`);
            }).catch(function(error) {
                console.error("Error fetching data:", error);
            });
        }

        function populateLeaderboard(data, currentUsername, userScore) {
            const leaderboardBody = document.querySelector('#leaderboard-table tbody');
            leaderboardBody.innerHTML = '';

            if (data.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = '<td colspan="3">No data available</td>';
                leaderboardBody.appendChild(row);
                return;
            }

            data.forEach((entry, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${entry.username}</td>
                    <td>${entry.score}</td>
                `;
                if (entry.username === currentUsername) {
                    row.style.color = 'yellow';
                }
                leaderboardBody.appendChild(row);
            });
        }

        function updateUserScore(score, identifier) {
            const userId = localStorage.getItem('antUserId');
            const username = localStorage.getItem('antUsername');
            if (!userId || !username) {
                console.error("User ID or username not found");
                return;
            }

            const updates = {};
            updates[`users/${userId}/lastScore`] = score;
            updates[`leaderboards/${identifier}/${userId}`] = {username: username, score: score};

            firebase.database().ref().update(updates).then(function() {
                console.log("Score updated successfully");
                gameEngine.postEvent('externalWriteGameAttribute', null, `game.attributes.${LAST_SCORE_ATTRIBUTE}`, score);
            }).catch(function(error) {
                console.error("Error updating score:", error);
            });
        }

        document.getElementById('username-submit-btn').addEventListener('click', function() {
            const username = document.getElementById('username-input').value.trim();
            if (username) {
                createUsername(username);
            } else {
                alert("Please enter a valid username.");
            }
        });

        document.getElementById('leaderboard-close-btn').addEventListener('click', function() {
            document.getElementById('leaderboard-overlay').style.display = 'none';
        });

        checkExistingAccount();
    })();
    </script>
</body>
</html>