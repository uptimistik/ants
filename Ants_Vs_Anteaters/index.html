<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<title>GameSalad with Fractal Authentication</title>
<link rel="stylesheet" type="text/css" href="css/gse-style.css" />
<link rel="stylesheet" type="text/css" href="css/gse-style-loading.css" />
<style type="text/css">
body {
  background-color: black;
  margin: 0;
  padding: 0;
}
</style>
</head>
<body>
<div id="gse-player" class="gse-frame">
  <div class="gse-overlay">
    <div id="gse-text" class="gse-dialog">
      <div>
        <button id="gse-text-cancel">Cancel</button>
        <button id="gse-text-done">Done</button>
        <p id="gse-text-prompt"></p>
      </div>
      <div>
        <textarea id="gse-text-input"></textarea>
      </div>
    </div>
    <div id="gse-browser" class="gse-dialog">     
      <iframe id="gse-browser-frame"></iframe>
        <button id="gse-browser-close" href="#">&#10006;</button>
    </div>
    <div id="gse-loading" style="visibility: visible;">
      <img src="images/gse-loading.png" />
    </div>
  </div>
</div>

<script type="text/javascript" src="https://cdn.fractal.is/sdk/fractal-sdk.js"></script>
<script type="text/javascript">
(function(global) {
  function LoLApi(messageName, payloadObj) {
    parent.postMessage({
      message: messageName,
      payload: JSON.stringify(payloadObj)
    }, '*');
  }

  global.onEngineLoad = function() {
    gse.ready(function(engine) {
      var loadingElement = document.getElementById('gse-loading');

      var playerDelegate = {
        onLoadingBegin: function() {
          engine.showOverlay();
          loadingElement.style.visibility = 'visible';
        },

        onLoadingEnd: function() {
          loadingElement.style.visibility = 'hidden';
          engine.hideOverlay();
        },

        onWindowResize: function() {
          engine.relayout();
        },

        onGameReady: function (width, height) {
          console.log('Game is ready');
          LoLApi('gameIsReady', {
            aspectRatio: "16:9",
            resolution: width + "x" + height
          });
          LoLApi('loadState', '*');
        },

        onGameCenterLogin: function () {
          console.log('Game Service Login triggered. Starting Fractal authentication...');
          return new Promise((resolve, reject) => {
            Fractal.onLoad(() => { // Ensures SDK is loaded before initialization
              Fractal.init({
                clientId: 'AL1szGybA0YVtyC5Jk5w3z6hBPCPvy6P',
                scopes: ['identify', 'coins:read', 'items:read'],
                onAuthSuccess: function (token) {
                  console.log('Authenticated successfully:', token);
                  resolve();
                },
                onAuthFailure: function (error) {
                  console.error('Authentication failed:', error);
                  reject(error);
                }
              });
              Fractal.authenticate();
            });
          });
        },

        onGameCenterShowLeaderboard: function () {
          console.log('Show Leaderboard');
          Fractal.get('/leaderboard', function (response) {
            console.log('Leaderboard:', response);
            let leaderboardHtml = '<div class="leaderboard"><h2>Leaderboard</h2><ul>';
            response.data.forEach(item => {
              leaderboardHtml += `<li>${item.username}: ${item.score}</li>`;
            });
            leaderboardHtml += '</ul></div>';
            document.body.innerHTML += leaderboardHtml;
          });
        },

        onGameCenterPostScore: function (score, leaderboard) {
          console.log('Posting score:', score);
          Fractal.post('/leaderboard/score', { score: score }, function (response) {
            console.log('Score posted:', response);
          });
        }
      };

      engine.appendDelegate(playerDelegate);
      window.addEventListener('resize', playerDelegate.onWindowResize, false);

      engine.setRenderFrame('gse-player');
      engine.setOptions({
        'viewport-reference': 'window',
        'viewport-fit': 'letterbox'
      });
      engine.loadOptionsFromURL();
      engine.play();
    });
  };
}(window));
</script>
<script type="text/javascript" src="js/gse/gse-export.js" async onload="onEngineLoad()"></script>
</body>
</html>
