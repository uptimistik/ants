<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AntsTheGame</title>
    <link rel="stylesheet" type="text/css" href="css/gse-style.css" />
    <link rel="stylesheet" type="text/css" href="css/gse-style-loading.css" />
    <link rel="stylesheet" type="text/css" href="css/styles.css" />
    <style>
        body {
            background-color: black;
            margin: 0;
            padding: 0;
        }
    </style>
</head>
<body>
    <div id="gse-player" class="gse-frame">
        <div class="gse-overlay">
            <div id="gse-text" class="gse-dialog">
                <div>
                    <button id="gse-text-cancel">Cancel</button>
                    <button id="gse-text-done">Done</button>
                    <p id="gse-text-prompt"></p>
                </div>
                <div>
                    <textarea id="gse-text-input"></textarea>
                </div>
            </div>
            <div id="gse-browser" class="gse-dialog">            
                <iframe id="gse-browser-frame"></iframe>
                <button id="gse-browser-close" href="#">&#10006;</button>
            </div>
            <div id="gse-loading" style="visibility: visible;">
                <img src="images/gse-loading.png" alt="Loading..." />
            </div>
        </div>
    </div>

    <div id="username-overlay" class="overlay">
        <div class="overlay-content">
            <h2>Create Your Ant Name</h2>
            <input type="text" id="username-input" placeholder="Enter your ant name">
            <button id="username-submit-btn">Submit</button>
        </div>
    </div>

    <div id="leaderboard-overlay" class="overlay">
        <div class="overlay-content">
            <h2>Ant Leaderboard</h2>
            <p id="total-ants">Total Ants: <span>0</span></p>
            <p id="last-score">Your Last Score: <span>undefined</span></p>
            <p id="leaderboard-status" class="yellow-text">Leaderboard reset is in progress!</p>
            <table id="leaderboard-table">
                <thead>
                    <tr>
                        <th>Rank</th>
                        <th>Ant Name</th>
                        <th>Top Kills</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Leaderboard entries will be dynamically inserted here -->
                </tbody>
            </table>
            <button id="leaderboard-close-btn">Back</button>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="js/app.js"></script>

    <script type="text/javascript">
    (function() {
        let gameEngine;

        function checkExistingAccount() {
            if (localStorage.getItem('antUsername')) {
                loadGame();
            } else {
                showUsernameOverlay();
            }
        }

        function showUsernameOverlay() {
            document.getElementById('username-overlay').style.display = 'flex';
            document.getElementById('username-input').focus();
        }

        function createUsername(username) {
            firebase.database().ref('users').push({
                username: username,
                createdAt: firebase.database.ServerValue.TIMESTAMP
            }).then(function(ref) {
                localStorage.setItem('antUsername', username);
                localStorage.setItem('antUserId', ref.key);
                document.getElementById('username-overlay').style.display = 'none';
                loadGame();
            }).catch(function(error) {
                console.error("Error creating user:", error);
                alert("Error creating user. Please try again.");
            });
        }

        function loadGame() {
            window.onEngineLoad = function() {
                gse.ready(function(engine) {
                    gameEngine = engine;
                    var loadingElement = document.getElementById('gse-loading');
                    var playerDelegate = {
                        onLoadingBegin: function() {
                            engine.showOverlay();
                            loadingElement.style.visibility = 'visible';
                        },
                        onLoadingEnd: function() {
                            loadingElement.style.visibility = 'hidden';
                            engine.hideOverlay();
                        },
                        onWindowResize: function() {
                            engine.relayout();
                        },
                        onGameCenterShowLeaderboard: function(identifier) {
                            displayLeaderboard(identifier);
                        }
                    };

                    engine.appendDelegate(playerDelegate);
                    window.addEventListener('resize', playerDelegate.onWindowResize, false);

                    engine.setRenderFrame('gse-player');
                    engine.setOptions({
                        'viewport-reference': 'window',
                        'viewport-fit': 'letterbox'
                    });
                    engine.loadOptionsFromURL();
                    engine.play();
                });
            };

            var script = document.createElement('script');
            script.type = 'text/javascript';
            script.src = 'js/gse/gse-export.js';
            script.async = true;
            script.onload = window.onEngineLoad;
            document.body.appendChild(script);
        }

        function displayLeaderboard(identifier) {
            firebase.database().ref('leaderboards/' + identifier).orderByChild('score').limitToLast(10).once('value')
                .then(function(snapshot) {
                    var leaderboardData = [];
                    snapshot.forEach(function(childSnapshot) {
                        leaderboardData.unshift(childSnapshot.val());
                    });
                    populateLeaderboard(leaderboardData);
                    document.getElementById('leaderboard-overlay').style.display = 'flex';
                    document.getElementById('total-ants').querySelector('span').textContent = leaderboardData.length;
                    // Set last score (you'll need to implement this based on your data structure)
                    // document.getElementById('last-score').querySelector('span').textContent = lastScore;
                })
                .catch(function(error) {
                    console.error("Error fetching leaderboard data:", error);
                });
        }

        function populateLeaderboard(data) {
            var leaderboardBody = document.querySelector('#leaderboard-table tbody');
            leaderboardBody.innerHTML = '';
            var currentUser = localStorage.getItem('antUsername');
            data.forEach(function(entry, index) {
                var row = leaderboardBody.insertRow();
                row.insertCell(0).textContent = index + 1;
                var nameCell = row.insertCell(1);
                var antIcon = document.createElement('span');
                antIcon.className = 'ant-icon';
                antIcon.textContent = entry.username[0].toUpperCase();
                nameCell.appendChild(antIcon);
                nameCell.appendChild(document.createTextNode(entry.username));
                if (entry.username === currentUser) {
                    var yellowDot = document.createElement('span');
                    yellowDot.className = 'yellow-dot';
                    nameCell.appendChild(yellowDot);
                }
                row.insertCell(2).textContent = entry.score;
            });
        }

        // Event Listeners
        document.getElementById('username-submit-btn').addEventListener('click', function() {
            var username = document.getElementById('username-input').value.trim();
            if (username) {
                createUsername(username);
            }
        });

        document.getElementById('leaderboard-close-btn').addEventListener('click', function() {
            document.getElementById('leaderboard-overlay').style.display = 'none';
        });

        // Start the process
        checkExistingAccount();
    })();
    </script>
</body>
</html>