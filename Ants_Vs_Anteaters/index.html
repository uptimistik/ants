<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>GameSalad Telegram Mini App</title>
  <link rel="stylesheet" type="text/css" href="css/gse-style.css" />
  <link rel="stylesheet" type="text/css" href="css/gse-style-loading.css" />
  <style type="text/css">
    body {
      background-color: black;
      margin: 0;
      padding: 0;
    }
    #endgame-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.8);
      display: none;
      color: white;
      text-align: center;
    }
    #leaderboard {
      margin: 20px auto;
      border-collapse: collapse;
    }
    #leaderboard th, #leaderboard td {
      padding: 10px;
      border: 1px solid white;
    }
    #share-button {
      padding: 10px 20px;
      font-size: 16px;
      cursor: pointer;
    }
  </style>
</head>

<body>
  <div id="gse-player" class="gse-frame">
    <div class="gse-overlay">
      <div id="gse-text" class="gse-dialog">
        <div>
          <button id="gse-text-cancel">Cancel</button>
          <button id="gse-text-done">Done</button>
          <p id="gse-text-prompt"></p>
        </div>
        <div>
          <textarea id="gse-text-input"></textarea>
        </div>
      </div>
      <div id="gse-loading" style="visibility: visible;">
        <img src="images/gse-loading.png" />
      </div>
    </div>
  </div>

  <div id="endgame-overlay">
    <h2>Leaderboard</h2>
    <table id="leaderboard">
      <tr>
        <th>Ant Name</th>
        <th>Top Kills</th>
      </tr>
    </table>
    <button id="share-button">Share</button>
  </div>

  <script type="text/javascript">
    window.idAsyncInit = function() {
      // Y8 specific code (if needed)
    };

    (function (global) {
      global.onEngineLoad = function () {
        gse.ready(function (engine) {
          var loadingElement = document.getElementById('gse-loading');
          var currentScore = 0; // Variable to track the current score

          var playerDelegate = { 
            onTouchPressed: function() {
              if (navigator.vibrate) {
                navigator.vibrate(50); // Vibrate for 50ms
              }
            },

            onTweetSheet: function (msg, img) {
              // Custom analytics or other actions can be added here
            },

            onSceneAboutToChange : function (sceneKey, sceneName, adType) {
              // Ad display logic can be added here
            },

            onCurrentSceneChanged: function (sceneKey, sceneName) {
            },

            onGameCenterPostScore: function (score, leaderboard) {
              currentScore = score; // Update the current score
              if (window.Telegram && window.Telegram.WebApp) {
                window.Telegram.WebApp.CloudStorage.setItem('leaderboard_' + leaderboard, score.toString(), function(error, success) {
                  if (success) {
                    console.log('Score posted to leaderboard');
                  }
                });
              }
            },

            onLoadingBegin: function () {
              engine.showOverlay();
              loadingElement.style.visibility = 'visible';
            },

            onLoadingEnd: function () {
              loadingElement.style.visibility = 'hidden';
              engine.hideOverlay();
            },

            onGameDimensionsKnown: function (width, height) {
            },

            onGameReady: function (width, height) {
              if (window.Telegram && window.Telegram.WebApp) {
                var user = window.Telegram.WebApp.initDataUnsafe.user;
                if (user) {
                  engine.postEvent('externalWriteGameAttribute', null, "game.attributes.telegramUser", {
                    id: user.id,
                    name: user.first_name + ' ' + user.last_name
                  });
                }
              }
            },

            onWindowResize: function () {
              engine.relayout();
            }
          };

          engine.appendDelegate(playerDelegate);
          window.addEventListener('resize', playerDelegate.onWindowResize, false);

          engine.setRenderFrame('gse-player');
          engine.setOptions({
            'viewport-reference': 'window',
            'viewport-fit': 'letterbox'
          });
          engine.loadOptionsFromURL();

          engine.play();
        });
      };

    }(window));

    function showEndgameOverlay() {
      document.getElementById('endgame-overlay').style.display = 'block';
      // Populate leaderboard here (you'll need to implement this based on your data structure)
      
      document.getElementById('share-button').addEventListener('click', function() {
        if (window.Telegram && window.Telegram.WebApp) {
          window.Telegram.WebApp.sendData(JSON.stringify({
            action: 'share_score',
            score: currentScore
          }));
        }
      });
    }
  </script>
  <script type="text/javascript" src="js/gse/gse-export.js" async onload="onEngineLoad()"></script>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</body>
</html>
