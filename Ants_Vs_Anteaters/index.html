<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Game with Firebase Leaderboard</title>
  <link rel="stylesheet" type="text/css" href="css/gse-style.css" />
  <link rel="stylesheet" type="text/css" href="css/gse-style-loading.css" />
  <style type="text/css">
    body {
      background-color: black;
      margin: 0;
      padding: 0;
    }
    #username-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    #username-form {
      background: white;
      padding: 20px;
      border-radius: 10px;
      text-align: center;
    }
    #username-form input {
      margin-bottom: 10px;
      padding: 10px;
      width: 100%;
      box-sizing: border-box;
    }
    #username-form button {
      padding: 10px;
      background: #4CAF50;
      color: white;
      border: none;
      cursor: pointer;
    }
    #username-form button:disabled {
      background: #9E9E9E;
    }
  </style>
  <script src="https://www.gstatic.com/firebasejs/9.9.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.9.2/firebase-database-compat.js"></script>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>

<body>
  <div id="username-overlay">
    <div id="username-form">
      <h2>Enter Username</h2>
      <input type="text" id="username-input" placeholder="Enter your username" />
      <button id="submit-button" disabled>Start Game</button>
    </div>
  </div>

  <div id="gse-player" class="gse-frame" style="display: none;">
    <div class="gse-overlay">
      <div id="gse-loading" style="visibility: visible;">
        <img src="images/gse-loading.png" />
      </div>
    </div>
  </div>

  <div id="leaderboard"></div>

  <script type="text/javascript">
    document.addEventListener('DOMContentLoaded', function() {
      const firebaseConfig = {
        apiKey: "AIzaSyCeS_7ev8inI1yvzkljhJn_IU7z5cJIp9k",
        authDomain: "antsgame-204c1.firebaseapp.com",
        databaseURL: "https://antsgame-204c1-default-rtdb.firebaseio.com",
        projectId: "antsgame-204c1",
        storageBucket: "antsgame-204c1.appspot.com",
        messagingSenderId: "580715522171",
        appId: "1:580715522171:web:0bba6c6a16399dc3fe5ade",
        measurementId: "G-E0JEEGY1GR"
      };

      firebase.initializeApp(firebaseConfig);
      const database = firebase.database();

      let playerName = '';

      // Handle username submission
      document.getElementById('submit-button').addEventListener('click', function() {
        playerName = document.getElementById('username-input').value.trim();
        if (playerName) {
          document.getElementById('username-overlay').style.display = 'none';
          document.getElementById('gse-player').style.display = 'block';
          startGame();
        } else {
          alert('Please enter a valid username');
        }
      });

      document.getElementById('username-input').addEventListener('input', function() {
        const username = this.value.trim();
        document.getElementById('submit-button').disabled = !username;
      });

      function startGame() {
        window.onEngineLoad = function() {
          gse.ready(function(engine) {
            const loadingElement = document.getElementById('gse-loading');

            var playerDelegate = {
              onGameCenterPostScore: function(score) {
                saveScoreToFirebase(score);
              },
              onLoadingBegin: function() {
                engine.showOverlay();
                loadingElement.style.visibility = 'visible';
              },
              onLoadingEnd: function() {
                loadingElement.style.visibility = 'hidden';
                engine.hideOverlay();
              },
              onGameReady: function() {
                loadLeaderboard(); // Load and display the leaderboard when the game is ready
              },
              onWindowResize: function() {
                engine.relayout();
              }
            };

            engine.appendDelegate(playerDelegate);
            window.addEventListener('resize', playerDelegate.onWindowResize, false);

            engine.setRenderFrame('gse-player');
            engine.setOptions({
              'viewport-reference': 'window',
              'viewport-fit': 'letterbox'
            });
            engine.loadOptionsFromURL();
            engine.play();
          });
        };

        // Load game engine script
        const script = document.createElement('script');
        script.type = 'text/javascript';
        script.src = 'js/gse/gse-export.js';
        script.async = true;
        script.onload = window.onEngineLoad;
        document.body.appendChild(script);
      }

      function saveScoreToFirebase(score) {
        if (!playerName) {
          console.error('Failed to retrieve username');
          return;
        }

        const scoresRef = database.ref('scores');
        const newScoreRef = scoresRef.push();
        newScoreRef.set({
          name: playerName,
          score: score
        });
      }

      function loadLeaderboard() {
        const scoresRef = database.ref('scores').orderByChild('score').limitToLast(10);
        scoresRef.once('value', (snapshot) => {
          const scores = [];
          snapshot.forEach((childSnapshot) => {
            scores.unshift(childSnapshot.val()); // Add to the beginning to sort in descending order
          });
          displayLeaderboard(scores);
        });
      }

      function displayLeaderboard(scores) {
        const leaderboardElement = document.getElementById('leaderboard');
        if (leaderboardElement) {
          leaderboardElement.innerHTML = '';
          scores.forEach((entry) => {
            const entryElement = document.createElement('div');
            entryElement.textContent = `${entry.name}: ${entry.score}`;
            leaderboardElement.appendChild(entryElement);
          });
        } else {
          console.error('Leaderboard element not found.');
        }
      }
    });
  </script>
</body>
</html>
