<!DOCTYPE html>
<html lang="en">
<head>
    <!-- ... (keep the existing head content) ... -->
</head>
<body>
    <!-- ... (keep the existing body content up to the script tag) ... -->

    <script type="text/javascript">
    (function() {
        let gameEngine;

        function checkExistingAccount() {
            if (localStorage.getItem('antUsername')) {
                loadGame();
            } else {
                showUsernameOverlay();
            }
        }

        // ... (keep other existing functions) ...

        function loadGame() {
            window.onEngineLoad = function() {
                gse.ready(function(engine) {
                    gameEngine = engine;
                    var loadingElement = document.getElementById('gse-loading');
                    var playerDelegate = {
                        onLoadingBegin: function() {
                            engine.showOverlay();
                            loadingElement.style.visibility = 'visible';
                        },
                        onLoadingEnd: function() {
                            loadingElement.style.visibility = 'hidden';
                            engine.hideOverlay();
                        },
                        onWindowResize: function() {
                            engine.relayout();
                        },
                        onGameCenterShowLeaderboard: function(identifier) {
                            displayLeaderboard(identifier);
                        },
                        onGameCenterPostScore: function(score, identifier) {
                            updateUserScore(score, identifier);
                        }
                    };

                    engine.appendDelegate(playerDelegate);
                    window.addEventListener('resize', playerDelegate.onWindowResize, false);

                    engine.setRenderFrame('gse-player');
                    engine.setOptions({
                        'viewport-reference': 'window',
                        'viewport-fit': 'letterbox'
                    });
                    engine.loadOptionsFromURL();
                    engine.play();
                });
            };

            var script = document.createElement('script');
            script.type = 'text/javascript';
            script.src = 'js/gse/gse-export.js';
            script.async = true;
            script.onload = window.onEngineLoad;
            document.body.appendChild(script);
        }

        function displayLeaderboard(identifier) {
            firebase.database().ref('leaderboards/' + identifier).orderByChild('score').limitToLast(10).once('value')
                .then(function(snapshot) {
                    let leaderboardData = [];
                    snapshot.forEach(function(childSnapshot) {
                        leaderboardData.unshift(childSnapshot.val());
                    });

                    const userId = localStorage.getItem('antUserId');
                    const username = localStorage.getItem('antUsername');
                    const userScore = leaderboardData.find(entry => entry.username === username)?.score || 'N/A';
                    
                    populateLeaderboard(leaderboardData, username, userScore);
                    document.getElementById('leaderboard-overlay').style.display = 'flex';
                    document.getElementById('total-ants').querySelector('span').textContent = leaderboardData.length;
                    document.getElementById('last-score').querySelector('span').textContent = userScore;
                }).catch(function(error) {
                    console.error("Error fetching data:", error);
                });
        }

        function populateLeaderboard(data, currentUsername, userScore) {
            const leaderboardBody = document.querySelector('#leaderboard-table tbody');
            leaderboardBody.innerHTML = '';
            
            if (data.length === 0) {
                const row = leaderboardBody.insertRow();
                const cell = row.insertCell(0);
                cell.colSpan = 3;
                cell.textContent = "No data available yet";
            } else {
                data.forEach(function(entry, index) {
                    const row = leaderboardBody.insertRow();
                    row.insertCell(0).textContent = index + 1;
                    const nameCell = row.insertCell(1);
                    const antIcon = document.createElement('span');
                    antIcon.className = 'ant-icon';
                    antIcon.textContent = entry.username[0].toUpperCase();
                    nameCell.appendChild(antIcon);
                    nameCell.appendChild(document.createTextNode(entry.username));
                    if (entry.username === currentUsername) {
                        const yellowDot = document.createElement('span');
                        yellowDot.className = 'yellow-dot';
                        nameCell.appendChild(yellowDot);
                    }
                    row.insertCell(2).textContent = entry.score;
                });
            }

            // Ensure current user is in the leaderboard if not already present
            if (!data.some(entry => entry.username === currentUsername)) {
                const row = leaderboardBody.insertRow();
                row.insertCell(0).textContent = '-';
                const nameCell = row.insertCell(1);
                const antIcon = document.createElement('span');
                antIcon.className = 'ant-icon';
                antIcon.textContent = currentUsername[0].toUpperCase();
                nameCell.appendChild(antIcon);
                nameCell.appendChild(document.createTextNode(currentUsername));
                const yellowDot = document.createElement('span');
                yellowDot.className = 'yellow-dot';
                nameCell.appendChild(yellowDot);
                row.insertCell(2).textContent = userScore;
            }
        }

        function updateUserScore(score, identifier) {
            const userId = localStorage.getItem('antUserId');
            const username = localStorage.getItem('antUsername');
            if (userId && username) {
                const updates = {};
                updates['/users/' + userId + '/lastScore'] = score;
                updates['/leaderboards/' + identifier + '/' + userId] = {
                    username: username,
                    score: score
                };
                firebase.database().ref().update(updates).then(() => {
                    console.log("Score updated successfully");
                    displayLeaderboard(identifier);
                }).catch((error) => {
                    console.error("Error updating score:", error);
                });
            }
        }

        // ... (keep other existing event listeners and function calls) ...

        // Start the process
        checkExistingAccount();
    })();
    </script>
</body>
</html>