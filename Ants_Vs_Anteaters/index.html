<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>GameSalad Telegram Mini App</title>
  <link rel="stylesheet" type="text/css" href="css/gse-style.css" />
  <link rel="stylesheet" type="text/css" href="css/gse-style-loading.css" />
  <style type="text/css">
    body {
      background-color: black;
      margin: 0;
      padding: 0;
    }
    .overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.8);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      color: white;
      text-align: center;
      z-index: 1000;
    }
    #welcome-overlay h1 {
      font-size: 24px;
      margin-bottom: 20px;
    }
    #start-game-button, #share-button, #replay-button {
      padding: 10px 20px;
      font-size: 16px;
      cursor: pointer;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 5px;
      margin-top: 20px;
    }
    #leaderboard {
      margin: 20px auto;
      border-collapse: collapse;
    }
    #leaderboard th, #leaderboard td {
      padding: 10px;
      border: 1px solid white;
    }
    .avatar {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      background-color: #4CAF50;
      color: white;
      display: inline-flex;
      justify-content: center;
      align-items: center;
      margin-right: 10px;
      font-weight: bold;
    }
    .current-player-icon {
      display: inline-block;
      width: 20px;
      height: 20px;
      background-color: #FFD700;
      border-radius: 50%;
      margin-left: 10px;
      vertical-align: middle;
    }
    #current-player-row {
      margin-top: 10px;
      font-weight: bold;
    }
    #leaderboard-countdown {
      font-size: 14px;
      margin-bottom: 10px;
      color: #FFD700;
    }
  </style>
</head>

<body>
  <div id="gse-player" class="gse-frame">
    <div class="gse-overlay">
      <div id="gse-text" class="gse-dialog">
        <div>
          <button id="gse-text-cancel">Cancel</button>
          <button id="gse-text-done">Done</button>
          <p id="gse-text-prompt"></p>
        </div>
        <div>
          <textarea id="gse-text-input"></textarea>
        </div>
      </div>
      <div id="gse-loading" style="visibility: visible;">
        <img src="images/gse-loading.png" />
      </div>
    </div>
  </div>

  <div id="welcome-overlay" class="overlay">
    <h1>Start <span id="telegram-name"></span></h1>
    <button id="start-game-button">Start Game</button>
  </div>

  <div id="endgame-overlay" class="overlay" style="display: none;">
    <h2>Top 5 Ants</h2>
    <div id="leaderboard-countdown"></div>
    <table id="leaderboard">
      <tr>
        <th>Ant Name</th>
        <th>Top Kills</th>
      </tr>
    </table>
    <div id="current-player-row"></div>
    <button id="share-button">Share</button>
    <button id="replay-button">Play Again</button>
  </div>

  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <script type="text/javascript">
    // Initialize Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyCeS_7ev8inI1yvzkljhJn_IU7z5cJIp9k",
      authDomain: "antsgame-204c1.firebaseapp.com",
      databaseURL: "https://antsgame-204c1-default-rtdb.firebaseio.com",
      projectId: "antsgame-204c1",
      storageBucket: "antsgame-204c1.appspot.com",
      messagingSenderId: "580715522171",
      appId: "1:580715522171:web:0bba6c6a16399dc3fe5ade",
      measurementId: "G-E0JEEGY1GR"
    };
    firebase.initializeApp(firebaseConfig);

    (function (global) {
      var currentScore = 0;
      var telegramUser = null;
      var engine = null;

      global.onEngineLoad = function () {
        gse.ready(function (gseEngine) {
          engine = gseEngine;
          var loadingElement = document.getElementById('gse-loading');

          var playerDelegate = { 
            onTouchPressed: function() {
              if (navigator.vibrate) {
                navigator.vibrate(50); // Vibrate for 50ms
              }
            },

            onTweetSheet: function (msg, img) {
              // Custom analytics or other actions can be added here
            },

            onSceneAboutToChange : function (sceneKey, sceneName, adType) {
              // Ad display logic can be added here
            },

            onCurrentSceneChanged: function (sceneKey, sceneName) {
            },

            onGameCenterPostScore: function (score, leaderboard) {
              currentScore = score;
              if (telegramUser) {
                updateFirebaseScore(telegramUser.id, telegramUser.first_name + ' ' + telegramUser.last_name, score);
              }
            },

            onGameCenterShowLeaderboard: function(leaderboard) {
              updateLeaderboard().then(() => {
                showEndgameOverlay();
              });
            },

            onLoadingBegin: function () {
              engine.showOverlay();
              loadingElement.style.visibility = 'visible';
            },

            onLoadingEnd: function () {
              loadingElement.style.visibility = 'hidden';
              engine.hideOverlay();
            },

            onGameDimensionsKnown: function (width, height) {
            },

            onGameReady: function (width, height) {
              if (window.Telegram && window.Telegram.WebApp) {
                telegramUser = window.Telegram.WebApp.initDataUnsafe.user;
                if (telegramUser) {
                  document.getElementById('telegram-name').textContent = telegramUser.first_name + ' ' + telegramUser.last_name;
                  engine.postEvent('externalWriteGameAttribute', null, "game.attributes.telegramUser", {
                    id: telegramUser.id,
                    name: telegramUser.first_name + ' ' + telegramUser.last_name
                  });
                }
              }
              document.getElementById('welcome-overlay').style.display = 'flex';
            },

            onWindowResize: function () {
              engine.relayout();
            }
          };

          engine.appendDelegate(playerDelegate);
          window.addEventListener('resize', playerDelegate.onWindowResize, false);

          engine.setRenderFrame('gse-player');
          engine.setOptions({
            'viewport-reference': 'window',
            'viewport-fit': 'letterbox'
          });
          engine.loadOptionsFromURL();

          document.getElementById('start-game-button').addEventListener('click', function() {
            document.getElementById('welcome-overlay').style.display = 'none';
            engine.play();
          });

          document.getElementById('share-button').addEventListener('click', function() {
            if (window.Telegram && window.Telegram.WebApp) {
              const shareText = encodeURIComponent(`I just scored ${currentScore} kills in Ant Game! Can you beat me?`);
              const shareUrl = `https://t.me/share/url?url=https://t.me/@Antsgame_bot&text=${shareText}`;
              window.Telegram.WebApp.openTelegramLink(shareUrl);
            }
          });

          document.getElementById('replay-button').addEventListener('click', function() {
            document.getElementById('endgame-overlay').style.display = 'none';
            engine.postEvent('resetGame', null, null, null);
            engine.play();
          });
        });
      };

      function updateFirebaseScore(userId, userName, score) {
        const userRef = firebase.database().ref('users/' + userId);
        userRef.once('value').then((snapshot) => {
          const userData = snapshot.val();
          if (!userData || userData.score < score) {
            userRef.set({
              id: userId,
              name: userName,
              score: score
            });
          }
        });
      }

      function updateLeaderboard() {
        return new Promise((resolve, reject) => {
          const leaderboardRef = firebase.database().ref('users');
          leaderboardRef.orderByChild('score').limitToLast(5).once('value', (snapshot) => {
            const leaderboardData = [];
            snapshot.forEach((childSnapshot) => {
              leaderboardData.unshift({
                id: childSnapshot.key,
                ...childSnapshot.val()
              });
            });

            updateLeaderboardWithCurrentPlayer(leaderboardData);
            resolve();
          }, (error) => {
            console.error("Error fetching leaderboard data:", error);
            reject(error);
          });
        });
      }

      function updateLeaderboardWithCurrentPlayer(leaderboardData) {
        let leaderboardHtml = '<tr><th>Ant Name</th><th>Top Kills</th></tr>';
        let currentPlayerInTop5 = false;
        let currentPlayerRank = leaderboardData.length + 1;

        leaderboardData.forEach((user, index) => {
          const initials = user.name.split(' ').map(n => n[0]).join('').toUpperCase();
          const avatarHtml = `<div class="avatar">${initials}</div>`;
          const isCurrentPlayer = user.id === telegramUser.id;
          const currentPlayerIcon = isCurrentPlayer ? '<span class="current-player-icon"></span>' : '';

          if (isCurrentPlayer) {
            currentPlayerInTop5 = true;
            currentPlayerRank = index + 1;
          }

          leaderboardHtml += `
            <tr>
              <td>${avatarHtml}${user.name}${currentPlayerIcon}</td>
              <td>${user.score}</td>
            </tr>`;
        });

        document.getElementById('leaderboard').innerHTML = leaderboardHtml;

        const currentPlayerRow = document.getElementById('current-player-row');
        if (!currentPlayerInTop5) {
          currentPlayerRow.innerHTML = `Your Rank: ${currentPlayerRank}, Your Score: ${currentScore}`;
        } else {
          currentPlayerRow.innerHTML = '';
        }
      }

      function updateCountdown() {
        const now = new Date();
        const target = new Date("2024-07-21T00:00:00Z"); // July 21st, 2024 at 12am UTC
        
        if (now >= target) {
          document.getElementById('leaderboard-countdown').textContent = "Leaderboard reset is in progress!";
          return;
        }

        const timeLeft = target - now;
        const days = Math.floor(timeLeft / (1000 * 60 * 60 * 24));
        const hours = Math.floor((timeLeft % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);

        document.getElementById('leaderboard-countdown').textContent = 
          `Leaderboard resets in: ${days}d ${hours}h ${minutes}m ${seconds}s`;
      }

      function startCountdownTimer() {
        updateCountdown();
        setInterval(updateCountdown, 1000);
      }

      function showEndgameOverlay() {
        document.getElementById('endgame-overlay').style.display = 'flex';
        startCountdownTimer();
      }

    }(window));
  </script>
  <script type="text/javascript" src="js/gse/gse-export.js" async onload="onEngineLoad()"></script>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</body>
</html>
