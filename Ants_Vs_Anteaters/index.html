<!-- ... (previous HTML remains the same) ... -->

<div id="endgame-overlay" class="overlay" style="display: none;">
  <h2>Top 5 Players</h2>
  <table id="leaderboard">
    <tr>
      <th>Player Name</th>
      <th>Top Score</th>
    </tr>
  </table>
  <button id="share-button">Share</button>
</div>

<script type="text/javascript">
  (function (global) {
    var currentScore = 0;
    var telegramUser = null;

    global.onEngineLoad = function () {
      gse.ready(function (engine) {
        // ... (previous code remains the same) ...

        var playerDelegate = { 
          // ... (other delegate methods remain the same) ...

          onGameCenterPostScore: function (score, leaderboard) {
            currentScore = score;
            if (window.Telegram && window.Telegram.WebApp) {
              // Store the score in Telegram's CloudStorage
              var scoreData = JSON.stringify({
                name: telegramUser.first_name + ' ' + telegramUser.last_name,
                score: score
              });
              window.Telegram.WebApp.CloudStorage.setItem('score_' + telegramUser.id, scoreData, function(error, success) {
                if (success) {
                  console.log('Score posted to CloudStorage');
                  updateLeaderboard();
                }
              });
            }
          },

          onGameCenterShowLeaderboard: function(leaderboard) {
            updateLeaderboard().then(() => {
              showEndgameOverlay();
            });
          },

          // ... (other delegate methods remain the same) ...
        };

        // ... (previous code remains the same) ...

        engine.play();
      });
    };

    function updateLeaderboard() {
      return new Promise((resolve, reject) => {
        if (window.Telegram && window.Telegram.WebApp) {
          window.Telegram.WebApp.CloudStorage.getKeys(function(error, keys) {
            if (error) {
              console.error('Error getting keys:', error);
              reject(error);
              return;
            }

            var scoreKeys = keys.filter(key => key.startsWith('score_'));
            var promises = scoreKeys.map(key => 
              new Promise((resolve) => {
                window.Telegram.WebApp.CloudStorage.getItem(key, function(error, value) {
                  if (error) {
                    console.error('Error getting item:', error);
                    resolve(null);
                  } else {
                    resolve(JSON.parse(value));
                  }
                });
              })
            );

            Promise.all(promises).then(scores => {
              scores = scores.filter(score => score !== null);
              scores.sort((a, b) => b.score - a.score);
              var top5 = scores.slice(0, 5);

              var leaderboardHtml = '<tr><th>Player Name</th><th>Top Score</th></tr>';
              top5.forEach(score => {
                leaderboardHtml += `<tr><td>${score.name}</td><td>${score.score}</td></tr>`;
              });

              document.getElementById('leaderboard').innerHTML = leaderboardHtml;
              resolve();
            });
          });
        } else {
          reject('Telegram WebApp not available');
        }
      });
    }

    function showEndgameOverlay() {
      document.getElementById('endgame-overlay').style.display = 'flex';
      
      document.getElementById('share-button').addEventListener('click', function() {
        if (window.Telegram && window.Telegram.WebApp) {
          window.Telegram.WebApp.sendData(JSON.stringify({
            action: 'share_score',
            score: currentScore
          }));
        }
      });
    }

  }(window));
</script>
<!-- ... (rest of the HTML remains the same) ... -->
