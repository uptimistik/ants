<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>GameSalad with Fractal SDK</title>
  <link rel="stylesheet" type="text/css" href="css/gse-style.css">
  <style>
    body {
      background-color: black;
      margin: 0;
      padding: 0;
    }
  </style>
</head>
<body>
  <div id="gse-player" class="gse-frame">
    <div class="gse-overlay">
      <div id="gse-text" class="gse-dialog">
        <div>
          <button id="gse-text-cancel">Cancel</button>
          <button id="gse-text-done">Done</button>
          <p id="gse-text-prompt"></p>
        </div>
        <div>
          <textarea id="gse-text-input"></textarea>
        </div>
      </div>
      <div id="gse-loading" style="visibility: visible;">
        <img src="images/gse-loading.png" />
      </div>
    </div>
  </div>
  <script type="text/javascript">
    (function (global) {
      const clientId = 'AL1szGybA0YVtyC5Jk5w3z6hBPCPvy6P';
      const clientSecret = 'PxkK_3u7n9Zn89wYxGjUEo-iZBxulnTVmepU-DfYAisraw_LkCC9fj1cS4scPUm4';

      async function getApprovalUrl(clientId, scopes, codeChallenge) {
        const response = await fetch('https://auth-api.fractal.is/auth/signin_v2/authorize', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            clientId: clientId,
            scopes: scopes,
            codeChallenge: codeChallenge
          })
        });
        if (!response.ok) {
          throw new Error(`Error: ${response.status} - ${response.statusText}`);
        }
        const data = await response.json();
        return data.approvalUrl;
      }

      async function verifyAuthentication(clientId, code) {
        const response = await fetch('https://auth-api.fractal.is/auth/signin_v2/token', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            clientId: clientId,
            code: code
          })
        });
        if (!response.ok) {
          throw new Error(`Error: ${response.status} - ${response.statusText}`);
        }
        const data = await response.json();
        return data.accessToken;
      }

      async function getUserInfo(accessToken) {
        try {
          const response = await fetch('https://api.fractal.is/user', {
            headers: {
              'Authorization': `Bearer ${accessToken}`
            }
          });
          const userInfo = await response.json();
          console.log('User Info:', userInfo);
        } catch (error) {
          console.error('Error fetching user info:', error);
        }
      }

      function generateCodeVerifier() {
        const array = new Uint32Array(56 / 2);
        window.crypto.getRandomValues(array);
        return Array.from(array, dec => ('0' + dec.toString(16)).substr(-2)).join('');
      }

      function sha256(plain) {
        const encoder = new TextEncoder();
        const data = encoder.encode(plain);
        return window.crypto.subtle.digest('SHA-256', data);
      }

      function base64urlencode(a) {
        let str = '';
        new Uint8Array(a).forEach(b => str += String.fromCharCode(b));
        return btoa(str).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
      }

      async function startAuthentication(clientId) {
        const codeVerifier = generateCodeVerifier();
        const codeChallenge = base64urlencode(await sha256(codeVerifier));

        try {
          const approvalUrl = await getApprovalUrl(clientId, ['identify', 'coins:read', 'items:read'], codeChallenge);
          window.location.href = approvalUrl;
        } catch (error) {
          console.error('Failed to get approval URL:', error.message);
        }

        // Polling for authentication status
        let accessToken;
        const poller = setInterval(async () => {
          try {
            accessToken = await verifyAuthentication(clientId, codeVerifier);
            if (accessToken) {
              clearInterval(poller);
              await getUserInfo(accessToken);
            }
          } catch (error) {
            console.error('Error verifying authentication:', error.message);
          }
        }, 5000);
      }

      global.onEngineLoad = function () {
        gse.ready(function (engine) {
          var loadingElement = document.getElementById('gse-loading');

          window.addEventListener("message", function (msg) {
            const { messageName, payload } = msg.data;
            if (messageName === "start" && engine.state === 'GAME_READY') {
              engine.play();
              console.log('Start Game...', payload);
            }
          });

          engine.setRenderFrame('gse-player');
          engine.setOptions({
            'viewport-reference': 'window',
            'viewport-fit': 'letterbox'
          });
          engine.loadOptionsFromURL();
          engine.load();

          // Start Fractal Authentication
          startAuthentication(clientId);
        });
      };

    }(window));
  </script>
  <script type="text/javascript" src="js/gse/gse-export.js" async onload="onEngineLoad()"></script>
</body>
</html>
