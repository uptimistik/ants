<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>GameSalad Telegram Mini App</title>
  <link rel="stylesheet" type="text/css" href="css/gse-style.css" />
  <link rel="stylesheet" type="text/css" href="css/gse-style-loading.css" />
  <style type="text/css">
    body {
      background-color: black;
      margin: 0;
      padding: 0;
    }
    .overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.8);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      color: white;
      text-align: center;
      z-index: 1000;
    }
    #welcome-overlay h1, #username-overlay h2 {
      font-size: 24px;
      margin-bottom: 20px;
    }
    #start-game-button, #share-button, #replay-button, #submit-username-button {
      padding: 10px 20px;
      font-size: 16px;
      cursor: pointer;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 5px;
      margin-top: 20px;
    }
    #leaderboard {
      margin: 20px auto;
      border-collapse: collapse;
    }
    #leaderboard th, #leaderboard td {
      padding: 10px;
      border: 1px solid white;
    }
    .avatar {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      background-color: #4CAF50;
      color: white;
      display: inline-flex;
      justify-content: center;
      align-items: center;
      margin-right: 10px;
      font-weight: bold;
    }
    #username-input {
      padding: 10px;
      font-size: 16px;
      margin-top: 10px;
    }
  </style>
</head>

<body>
  <div id="gse-player" class="gse-frame">
    <div class="gse-overlay">
      <div id="gse-text" class="gse-dialog">
        <div>
          <button id="gse-text-cancel">Cancel</button>
          <button id="gse-text-done">Done</button>
          <p id="gse-text-prompt"></p>
        </div>
        <div>
          <textarea id="gse-text-input"></textarea>
        </div>
      </div>
      <div id="gse-loading" style="visibility: visible;">
        <img src="images/gse-loading.png" />
      </div>
    </div>
  </div>

  <div id="username-overlay" class="overlay" style="display: none;">
    <h2>Enter Your Username</h2>
    <input type="text" id="username-input" placeholder="Enter username" maxlength="20">
    <button id="submit-username-button">Submit</button>
  </div>

  <div id="welcome-overlay" class="overlay" style="display: none;">
    <h1>Welcome, <span id="player-name"></span></h1>
    <button id="start-game-button">Start Game</button>
  </div>

  <div id="endgame-overlay" class="overlay" style="display: none;">
    <h2>Top 5 Ants</h2>
    <table id="leaderboard">
      <tr>
        <th>Ant Name</th>
        <th>Top Kills</th>
      </tr>
    </table>
    <button id="share-button">Share</button>
    <button id="replay-button">Play Again</button>
  </div>

  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <script type="text/javascript">
    // Initialize Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyCeS_7ev8inI1yvzkljhJn_IU7z5cJIp9k",
      authDomain: "antsgame-204c1.firebaseapp.com",
      databaseURL: "https://antsgame-204c1-default-rtdb.firebaseio.com",
      projectId: "antsgame-204c1",
      storageBucket: "antsgame-204c1.appspot.com",
      messagingSenderId: "580715522171",
      appId: "1:580715522171:web:0bba6c6a16399dc3fe5ade",
      measurementId: "G-E0JEEGY1GR"
    };
    firebase.initializeApp(firebaseConfig);

    let currentScore = 0;
    let telegramUser = null;
    let engine = null;
    let isOnTelegram = false;
    let username = '';
    let userId = '';

    function generateUniqueId() {
      return 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    }

    function initializeGame() {
      console.log("Initializing game...");
      if (window.Telegram && window.Telegram.WebApp) {
        console.log("Telegram WebApp detected");
        isOnTelegram = true;
        telegramUser = window.Telegram.WebApp.initDataUnsafe.user;
        if (telegramUser) {
          username = telegramUser.first_name + ' ' + telegramUser.last_name;
          userId = telegramUser.id.toString();
          document.getElementById('player-name').textContent = username;
          document.getElementById('welcome-overlay').style.display = 'flex';
        }
      } else {
        console.log("Not on Telegram, showing username overlay");
        document.getElementById('username-overlay').style.display = 'flex';
      }
    }

    function onEngineLoad() {
      console.log("onEngineLoad called");
      if (typeof gse === 'undefined') {
        console.error("GSE not loaded");
        return;
      }
      
      gse.ready(function (gseEngine) {
        console.log("GSE engine ready");
        engine = gseEngine;
        let loadingElement = document.getElementById('gse-loading');

        let playerDelegate = {
          onTouchPressed: function() {
            if (navigator.vibrate) {
              navigator.vibrate(50);
            }
          },
          onGameCenterPostScore: function (score, leaderboard) {
            currentScore = score;
            updateFirebaseScore(userId, username, score);
          },
          onGameCenterShowLeaderboard: function(leaderboard) {
            updateLeaderboard().then(() => {
              showEndgameOverlay();
            });
          },
          onLoadingBegin: function () {
            engine.showOverlay();
            loadingElement.style.visibility = 'visible';
          },
          onLoadingEnd: function () {
            loadingElement.style.visibility = 'hidden';
            engine.hideOverlay();
          },
          onGameReady: function (width, height) {
            console.log("Game ready");
            initializeGame();
          },
          onWindowResize: function () {
            engine.relayout();
          }
        };

        engine.appendDelegate(playerDelegate);
        window.addEventListener('resize', playerDelegate.onWindowResize, false);

        engine.setRenderFrame('gse-player');
        engine.setOptions({
          'viewport-reference': 'window',
          'viewport-fit': 'letterbox'
        });
        engine.loadOptionsFromURL();
      });
    }

    document.getElementById('submit-username-button').addEventListener('click', function() {
      username = document.getElementById('username-input').value.trim();
      if (username) {
        userId = generateUniqueId();
        document.getElementById('username-overlay').style.display = 'none';
        document.getElementById('player-name').textContent = username;
        document.getElementById('welcome-overlay').style.display = 'flex';
      } else {
        alert('Please enter a valid username');
      }
    });

    document.getElementById('start-game-button').addEventListener('click', function() {
      console.log("Start game button clicked");
      document.getElementById('welcome-overlay').style.display = 'none';
      if (engine) {
        console.log("Starting game...");
        engine.play();
      } else {
        console.error("Engine not loaded yet");
      }
    });

    document.getElementById('share-button').addEventListener('click', function() {
      if (window.Telegram && window.Telegram.WebApp) {
        const shareText = encodeURIComponent(`I just scored ${currentScore} kills in Ant Game! Can you beat me?`);
        const shareUrl = `https://t.me/share/url?url=https://t.me/@Antsgame_bot&text=${shareText}`;
        window.Telegram.WebApp.openTelegramLink(shareUrl);
      } else {
        alert(`I just scored ${currentScore} kills in Ant Game! Can you beat me?`);
      }
    });

    document.getElementById('replay-button').addEventListener('click', function() {
      document.getElementById('endgame-overlay').style.display = 'none';
      if (engine) {
        engine.postEvent('resetGame', null, null, null);
        engine.play();
      }
    });

    function updateFirebaseScore(userId, userName, score) {
      const userRef = firebase.database().ref('users/' + userId);
      userRef.once('value').then((snapshot) => {
        const userData = snapshot.val();
        if (!userData || userData.score < score) {
          userRef.set({
            name: userName,
            score: score
          });
        }
      });
    }

    function updateLeaderboard() {
      return new Promise((resolve, reject) => {
        const leaderboardRef = firebase.database().ref('users');
        leaderboardRef.orderByChild('score').limitToLast(5).once('value', (snapshot) => {
          const leaderboardData = [];
          snapshot.forEach((childSnapshot) => {
            leaderboardData.unshift(childSnapshot.val());
          });

          let leaderboardHtml = '<tr><th>Ant Name</th><th>Top Kills</th></tr>';
          leaderboardData.forEach(user => {
            const initials = user.name.split(' ').map(n => n[0]).join('').toUpperCase();
            const avatarHtml = `<div class="avatar">${initials}</div>`;
            leaderboardHtml += `
              <tr>
                <td>${avatarHtml}${user.name}</td>
                <td>${user.score}</td>
              </tr>`;
          });

          document.getElementById('leaderboard').innerHTML = leaderboardHtml;
          resolve();
        }, (error) => {
          console.error("Error fetching leaderboard data:", error);
          reject(error);
        });
      });
    }

    function showEndgameOverlay() {
      document.getElementById('endgame-overlay').style.display = 'flex';
    }

    // Initialize Telegram WebApp
    if (window.Telegram && window.Telegram.WebApp) {
      console.log("Initializing Telegram WebApp");
      window.Telegram.WebApp.ready();
    }

    // Attempt to load the engine
    window.addEventListener('load', function() {
      console.log("Window loaded, attempting to load engine");
      onEngineLoad();
    });
  </script>
  <script type="text/javascript" src="js/gse/gse-export.js" async onload="console.log('gse-export.js loaded'); if(typeof onEngineLoad === 'function') onEngineLoad();"></script>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</body>
</html>
